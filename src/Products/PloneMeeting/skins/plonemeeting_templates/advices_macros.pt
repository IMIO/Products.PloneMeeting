<tal:comment replace="nothing">Displays advices as icons. Requires "meetingItem".</tal:comment>
<metal:icons metal:define-macro="advicesIcons" i18n:domain="PloneMeeting"
     tal:define="advicesByType meetingItem/getAdvicesByType;
                 adviceStyle python: meetingConfig.getUserParam('adviceStyle');
                 advisableGroups python: meetingItem.getAdvicesGroupsInfosForUser();
                 advicesToAdd python: advisableGroups[0];
                 advicesToEdit python: advisableGroups[1];
                 portal_url context/@@plone_portal_state/portal_url;
                 isRealManager python: tool.isManager(realManagers=True);">

  <table width="#"
         class="contentActionsAX no-style-table" cellpadding="0" cellspacing="0"
         tal:attributes="width python: 10 + (advicesToAdd and 1 or 0) * 15 + len(advicesByType) * 26"
         tal:condition="advicesByType">
    <tr>
      <tal:comment replace="nothing">Icon for adding an advice</tal:comment>
      <td tal:condition="advicesToAdd" class="noPadding">
        <a href="++add++meetingadvice" class="link-overlay-pm-advice" tal:attributes="href string:${meetingItem/absolute_url}/++add++meetingadvice">
          <img i18n:attributes="title" title="advice_add" style="cursor:pointer"
               tal:attributes="src string:$portal_url/new.png;" />
        </a>
      </td>
      <tal:menu repeat="adviceType python: meetingConfig.getUsedAdviceTypes() + ('not_given',)">
      <td tal:condition="python: adviceType in advicesByType" class="noPadding">
        <dl class="actionMenuAX">
          <dt class="actionMenuHeaderAX pmLinks"><tal:comment replace="nothing">Icon with advice type</tal:comment>
              <a href="#">
                <img tal:attributes="src string:$portal_url/advice_${adviceStyle}_$adviceType.png; title adviceType"
                     i18n:attributes="title"/><span tal:replace="python: len(advicesByType[adviceType])"></span>
              </a>
          </dt>
          <dd class="actionMenuContentAX actionMenuContentAdvice">
            <ul style="cursor:default"> <tal:comment replace="nothing">List of group names</tal:comment>
              <li tal:repeat="advice python:advicesByType[adviceType]">
                <table class="no-style-table advices" cellpadding="2" cellspacing="2" width="100%"
                       tal:define="mayEdit python: isRealManager or (advicesToEdit and (advice['id'] in advicesToEdit))">
                  <tr>
                    <td class="noPadding"> <tal:comment replace="nothing">Name is surrounded with () if optional.</tal:comment>
                    <span tal:condition="advice/optional">(</span><b tal:content="structure advice/name"></b><span tal:condition="advice/optional">)</span>
                    </td>
                    <td align="right" width="17px" class="noPadding" tal:condition="mayEdit">
                      <form action="deleteAdvice" name="deleteAdvice" tal:attributes="action python: meetingItem.absolute_url() + '/@@delete_givenuid'">
                        <input type="hidden" value="#" name="selected_uid" tal:attributes="value advice/advice_uid">
                        <img style="cursor:pointer"
                             tal:attributes="src string:$portal_url/delete_icon.png;"
                             i18n:attributes="title"
                             title="Delete advice"
                             onclick="javascript:confirmDeleteObject(this)" />
                      </form>
                    </td>
                    <td align="right" width="17px" class="noPadding" tal:condition="python: mayEdit or (advicesToAdd and advice.has_key('comment') and advice['comment'] and (advice['id'] in [a[0] for a in advicesToAdd]))">
                    <a href="edit"
                       class="link-overlay-pm-advice"
                       tal:attributes="href python: meetingItem.absolute_url() + '/%s/edit' % advice['advice_id']">
                      <img i18n:attributes="title" title="advice_edit" style="cursor:pointer"
                           tal:attributes="src string:$portal_url/edit.gif;" />
                    </a>
                    </td>
                  </tr>

                </table>
                <tal:details condition="python: (adviceType != 'not_given') and advice['comment']">
                  <i style="font-size: 95%" tal:content="structure advice/comment"></i>
                </tal:details>
              </li>
            </ul>
          </dd>
        </dl>
      </td>
      </tal:menu>
    </tr>
  </table>
  <span tal:condition="not: advicesByType">-</span>
</metal:icons>
