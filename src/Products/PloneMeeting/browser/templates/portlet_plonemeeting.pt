<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="PloneMeeting">
<body>

<dl class="portlet portletPloneMeeting"
    tal:define="tool view/getPloneMeetingTool;
                inTool view/inTool;
                currentDateTime view/getCurrentDateTime;
                userIsAmongCreators python: tool.userIsAmong('creators');
                meetingConfig view/getCurrentMeetingConfig;
                isArchiveSite tool/isArchiveSite;
                meetingFolder view/getPloneMeetingFolder;
                itemStates meetingConfig/getItemTopicStates|nothing;
                templateItems view/templateItems;
                ploneDiskAware tool/getPloneDiskAware;
                portal_url tool/getSiteUrl;
                member tool/getUser">

    <dt class="portletHeader"><tal:app_name i18n:translate="app_name">PloneMeeting</tal:app_name>
     <div style="float:right; display: inline; position: absolute; right: 10px;">
         <img style="cursor:pointer"
              tal:condition="python: meetingConfig"
              tal:attributes="onClick python: 'href: window.location=\'%s\'' % meetingFolder.absolute_url();
                              src string:$portal_url/home.gif;
                              title meetingConfig/getName"/>
         <img style="cursor:pointer" title="hs_configuration" i18n:attributes="title"
              tal:condition="python: member.has_role('Manager')"
              tal:attributes="onClick python: 'href: window.location=\'%s\'' % tool.absolute_url();
                              src string:$portal_url/appyConfig.gif"/>
         <img style="cursor:pointer" title="user_preferences" i18n:attributes="title"
              tal:condition="python: not inTool and tool.getEnableUserPreferences()"
              tal:attributes="onClick python: 'href: window.location=\'%s/gotoPreferences\'' % meetingConfig.absolute_url();
                              src string:$portal_url/preferences.png"/>
         <img tal:condition="not: inTool" style="cursor:pointer" title="search_advanced"
              i18n:attributes="title"
              tal:attributes="onClick python: 'href: window.location=\'%s/search_form\'' % meetingFolder.absolute_url();
                              src string:$portal_url/search.gif"/>
     </div>
    </dt>

<table cellpadding="0" cellspacing="0" width="100%">
 <tal:comment replace="nothing">Section: items</tal:comment>
 <tal:items condition="python: not inTool and not isArchiveSite and (itemStates or userIsAmongCreators)">
 <tr>
  <td>
    <table width="100%" cellspacing="0" cellpadding="0">
     <tr>
      <td class="portletSection" i18n:translate="PloneMeeting_label_items"></td>
      <td style="text-align: right; padding-right: 0.5em;">
        <tal:comment replace="nothing">Create a new item</tal:comment>
        <a href="#"
        style="display: inline;"
           tal:condition="python: userIsAmongCreators and not ploneDiskAware"
           tal:attributes="href string:${meetingFolder/absolute_url}/createObject?type_name=MeetingItem${meetingConfig/getShortName};">
         <img tal:attributes="src string: $portal_url/new.png"
              title="create_meeting_item" i18n:attributes="title"/>
        </a>
        <tal:comment replace="nothing">Create a new item from a template</tal:comment>
        <a class="link-overlay-pm" style="display: inline; padding-left: 0;"
           href="@@createitemfromtemplate" tal:attributes="href string:${context/absolute_url}/createitemfromtemplate"
           tal:condition="python: userIsAmongCreators and templateItems and not ploneDiskAware">
        <img  style="cursor:pointer"
             tal:attributes="src string: $portal_url/new_from.png"
             title="create_meeting_item_from" i18n:attributes="title"/>
        </a>
      </td>
     </tr>
    </table>
  </td>
 </tr>
 <tal:comment replace="nothing">Item-related topics</tal:comment>
 <tr tal:condition="python: hasattr(meetingConfig, 'topics') and not isArchiveSite"
     tal:repeat="topic python: meetingConfig.getTopics('MeetingItem')">
   <td tal:condition="python: member.has_permission('View', topic)"
       tal:attributes="class python: topic.getId() == context.REQUEST.form.get('search', '') and 'portletCell portletSelected' or 'portletCell'">
      <a tal:attributes="href python: meetingFolder.absolute_url() + '/plonemeeting_topic_view?search=%s' % topic.getId()"
         i18n:translate="" tal:content="python: topic.Title() or topic.getId()"></a>
   </td>
 </tr>
 </tal:items>

 <tal:meetings condition="python: not inTool and not isArchiveSite">
 <tal:comment replace="nothing">Section: meetings</tal:comment>
 <tr>
  <td>
    <table width="100%" cellspacing="0" cellpadding="0">
     <tr>
      <td class="portletSection" i18n:translate="portletmeetings_title"></td>
      <td style="text-align: right; padding-right: 1em;">
        <tal:comment replace="nothing">Create a new meeting</tal:comment>
        <img style="cursor:pointer" tal:condition="python: member.has_permission('PloneMeeting: Add Meeting', context) and not ploneDiskAware"
             tal:attributes="onClick python: 'href: window.location=\'%s/createObject?type_name=Meeting%s\'' % (meetingFolder.absolute_url(), meetingConfig.getShortName());
                             src string: $portal_url/new.png"
             title="create_meeting" i18n:attributes="title"/>
      </td>
     </tr>
    </table>
  </td>
 </tr>
 <tal:comment replace="nothing">List of available meetings</tal:comment>
 <tal:links define="pc python:context.portal_catalog;
                    portalTypeName meetingConfig/getMeetingTypeName;
                    meetingStates meetingConfig/getMeetingTopicStates;
                    meetingBrains python:pc(portal_type=portalTypeName, review_state=meetingStates, sort_on='getDate', sort_order='reverse');
                    nbOfMeetings python:len(meetingBrains);
                    maxShownMeetings meetingConfig/maxShownMeetings">

    <tal:comment replace="nothing">A few number of meetings: show a link by meeting</tal:comment>
    <tr tal:condition="python: nbOfMeetings <= maxShownMeetings"
        tal:repeat="meetingBrain meetingBrains">
      <td class="portletCell">
        <a tal:attributes="href meetingBrain/getURL;
                           class python: context.absolute_url().startswith(meetingBrain.getURL()) and 'portletSelected' or ''"
           tal:content="python:tool.formatDate(meetingBrain, short=True, withHour=True)"></a>
      </td>
    </tr>

    <tal:comment replace="nothing">Many meetings. Show a combo box</tal:comment>
    <tr tal:condition="python: nbOfMeetings > maxShownMeetings">
     <td class="portletCell">
      <form name="gotoMeetingForm">
        <select style="width: 90%" name="selectMeeting" onChange="location.href=gotoMeetingForm.selectMeeting.options[selectedIndex].value">
          <option i18n:translate="make_a_choice"
                  tal:attributes="value python:meetingFolder.absolute_url() + '/plonemeeting_topic_view?search=searchallmeetings'"></option>
          <option tal:repeat="meetingBrain meetingBrains"
                  tal:content="python:tool.formatDate(meetingBrain, short=True, withHour=True)"
                  tal:attributes="value meetingBrain/getURL;
                                  selected python:context.absolute_url().startswith(meetingBrain.getURL())"></option>
        </select>
      </form>
     </td>
    </tr>

    <tr tal:condition="python: nbOfMeetings==0">
      <td class="portletCell"><i class="discreet" i18n:translate="no_meeting"></i></td>
    </tr>
  </tal:links>
  </tal:meetings>

  
  <tal:decisions condition="not: inTool">
  <tal:comment replace="nothing">Section: decisions</tal:comment>
  <tr><td class="portletSection" i18n:translate="portletdecisions_title">Decisions</td></tr>

  <tal:comment replace="nothing">List of available decisions</tal:comment>
  <tal:links define="pc python:context.portal_catalog;
                     portalTypeName meetingConfig/getMeetingTypeName;
                     meetingStates meetingConfig/getDecisionTopicStates;
                     meetingBrains python:pc(portal_type=portalTypeName, review_state=meetingStates, sort_on='getDate', sort_order='reverse', getDate={'query': currentDateTime-meetingConfig.getMaxDaysDecisions(), 'range': 'min'},);
                     nbOfMeetings python:len(meetingBrains);
                     maxShownMeetings meetingConfig/maxShownMeetings">

    <tal:comment replace="nothing">A few number of meetings: show a link by meeting</tal:comment>
    <tr tal:condition="python: nbOfMeetings <= maxShownMeetings"
        tal:repeat="meetingBrain meetingBrains">
     <td class="portletCell">
      <a tal:attributes="href meetingBrain/getURL;
                         class python: context.absolute_url().startswith(meetingBrain.getURL()) and 'portletSelected' or ''"
         tal:content="python:tool.formatDate(meetingBrain, short=True, withHour=True)"></a>
     </td>
    </tr>

    <tal:comment replace="nothing">Many meetings! Show a combo box</tal:comment>
    <tr tal:condition="python: nbOfMeetings > maxShownMeetings">
     <td class="portletCell">
      <form name="gotoDecision">
        <select name="selectDecision" onChange="location.href=gotoDecision.selectDecision.options[selectedIndex].value">
          <option i18n:translate="make_a_choice"
                  tal:attributes="value python:meetingFolder.absolute_url() + '/plonemeeting_topic_view?search=searchalldecisions'"></option>
          <option tal:repeat="meetingBrain meetingBrains"
                  tal:content="python:tool.formatDate(meetingBrain, short=True, withHour=True)"
                  tal:attributes="value meetingBrain/getURL;
                                  selected python:context.absolute_url().startswith(meetingBrain.getURL())"></option>
        </select>
      </form>
     </td>
    </tr>
  </tal:links>

  <tal:comment replace="nothing">All decisions</tal:comment>
  <tr>
   <td class="portletCell">
    <a tal:attributes="href python: meetingFolder.absolute_url() + '/plonemeeting_topic_view?search=searchalldecisions';
                       class python: 'searchalldecisions' == context.REQUEST.form.get('search', '') and 'portletSelected' or ''"
       i18n:translate="searchalldecisions"></a>
   </td>
  </tr>
  </tal:decisions>
</table>

<tal:comment replace="nothing">Here we define code corresponding to popups</tal:comment>
<tal:comment replace="nothing">All this will be removed when corresponding functionnalities will be adapted.
"deleteDialog" is for managing elements history (removing an element from an history) and byebye user is about MeetingUsers management</tal:comment>
<div id="hsGrey" class="hsGrey"></div>
<div id="deleteDialog" class="hsDialog">
  <form id="deleteForm" method="post"
        tal:attributes="action python:tool.absolute_url() + '/delete_givenuid'">
    <input type="hidden" name="selected_uid" id="objectUid"/>
    <tal:comment replace="nothing">
      Event time below is only required when deleting an event in an
      object's history.
    </tal:comment>
    <input type="hidden" name="event_time" id="eventTime"/>
    <div align="center" i18n:translate="plonemeeting_delete_confirm_message"></div><br/>
    <div align="center">
      <input type="submit" value="Ok" i18n:attributes="value" i18n:domain="plone"/>
      <input type="button" onClick="javascript:closeDialog('deleteDialog')"
             value="label_cancel" i18n:attributes="value" i18n:domain="plone"/>
    </div>
  </form>
</div>
<script language="javascript" tal:content="tool/getJavascriptMessages"></script>
</dl>
</body>
</html>
