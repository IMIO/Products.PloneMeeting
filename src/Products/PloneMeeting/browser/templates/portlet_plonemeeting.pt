<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="PloneMeeting">
<body>

<dl class="portlet portletPloneMeeting"
    tal:define="tool view/getPloneMeetingTool;
                currentDateTime view/getCurrentDateTime;
                userIsAmongCreators python: tool.userIsAmong('creators');
                meetingConfig view/getCurrentMeetingConfig;
                meetingFolder view/getPloneMeetingFolder;
                templateItems view/templateItems;
                portal_url tool/getSiteUrl;
                member tool/getUser">

    <dt class="portletHeader"><tal:portlet_pm_header i18n:translate="portlet_pm_header_label">Manage</tal:portlet_pm_header>
     <div class="portletPloneMeetingHeaderIcons">
         <a style="display: inline;"
            tal:condition="python: meetingConfig"
            href="#"
            tal:attributes="href meetingFolder/absolute_url">
         <img style="cursor:pointer"
              tal:attributes="src string:$portal_url/pm_home.png;
                              title meetingConfig/getName"/>
         </a>
         <a style="display: inline;"
            tal:condition="python: tool.isManager(view.context)"
            href="#"
            tal:attributes="href meetingConfig/absolute_url">
         <img style="cursor:pointer" title="pm_configuration" i18n:attributes="title"
              tal:attributes="src string:$portal_url/pm_config.png"/>
         </a>
         <a style="display: inline;"
            tal:condition="tool/getEnableUserPreferences"
            href="#"
            tal:attributes="href string:${meetingConfig/absolute_url}/gotoPreferences;">
         <img style="cursor:pointer" title="user_preferences" i18n:attributes="title"
              tal:attributes="src string:$portal_url/pm_preferences.png"/>
         </a>
         <a style="display: inline;" href="#" tal:attributes="href string:${meetingFolder/absolute_url}/search_form;">
         <img style="cursor:pointer" title="search_advanced"
              i18n:attributes="title"
              tal:attributes="src string:$portal_url/pm_search.png"/>
         </a>
     </div>
    </dt>

<table cellpadding="0" cellspacing="0" width="100%">
 <tal:comment replace="nothing">Section: items</tal:comment>
 <tr tal:condition="userIsAmongCreators">
  <td>
    <table width="100%" cellspacing="0" cellpadding="0">
     <tr>
      <td class="portletSection" i18n:translate="PloneMeeting_label_items"></td>
      <td style="text-align: right; padding-right: 0.5em;">
        <tal:comment replace="nothing">Create a new item</tal:comment>
        <a id="newItemCreation" href="#"
           style="display: inline;"
           tal:condition="not:meetingConfig/getItemCreatedOnlyUsingTemplate"
           tal:attributes="href string:${meetingFolder/absolute_url}/createObject?type_name=MeetingItem${meetingConfig/getShortName};">
            <img tal:attributes="src string: $portal_url/new.png"
              title="create_meeting_item" i18n:attributes="title" />
        </a>
        <tal:comment replace="nothing">Create a new item from a template</tal:comment>
        <a id="newTemplateItemCreation" class="link-overlay-pm" style="display: inline; padding-left: 0;"
           href="@@createitemfromtemplate" tal:attributes="href string:${meetingFolder/absolute_url}/@@createitemfromtemplate"
           tal:condition="templateItems">
        <img style="cursor:pointer"
             tal:attributes="src string: $portal_url/new_from.png"
             title="create_meeting_item_from_template"
             i18n:domain="plone"
             i18n:attributes="title"/>
        </a>
      </td>
     </tr>
    </table>
  </td>
 </tr>
 <tal:comment replace="nothing">Item-related topics</tal:comment>
 <tr tal:condition="python: hasattr(meetingConfig, 'topics')"
     tal:repeat="topic python: meetingConfig.getTopics('MeetingItem')">
   <td tal:condition="python: member.has_permission('View', topic)"
       tal:attributes="class python: topic.getId() == context.REQUEST.form.get('search', '') and 'portletCell portletSelected' or 'portletCell'">
      <a tal:attributes="href python: meetingFolder.absolute_url() + '/plonemeeting_topic_view?search=%s' % topic.getId()"
         i18n:translate="" tal:content="python: topic.Title() or topic.getId()"></a>
   </td>
 </tr>

 <tal:meetings>
 <tal:comment replace="nothing">Section: meetings</tal:comment>
 <tr>
  <td>
    <table width="100%" cellspacing="0" cellpadding="0">
     <tr>
      <td class="portletSection" i18n:translate="portletmeetings_title"></td>
      <td style="text-align: right; padding-right: 1em;">
        <tal:comment replace="nothing">Create a new meeting</tal:comment>
        <a id="newMeetingCreation" href="#"
           style="display: inline;"
           tal:condition="python: member.has_permission('PloneMeeting: Add Meeting', context)"
           tal:attributes="href string:${meetingFolder/absolute_url}/createObject?type_name=Meeting${meetingConfig/getShortName};">
            <img tal:attributes="src string: $portal_url/new.png"
              title="create_meeting" i18n:attributes="title" />
        </a>
      </td>
     </tr>
    </table>
  </td>
 </tr>
 <tal:comment replace="nothing">List of available meetings</tal:comment>
 <tal:links define="pc python:context.portal_catalog;
                    portalTypeName meetingConfig/getMeetingTypeName;
                    meetingStates meetingConfig/getMeetingTopicStates;
                    meetingBrains python:pc(portal_type=portalTypeName, review_state=meetingStates, sort_on='getDate', sort_order='reverse');
                    nbOfMeetings python:len(meetingBrains);
                    maxShownMeetings meetingConfig/maxShownMeetings">

    <tal:comment replace="nothing">A few number of meetings: show a link by meeting</tal:comment>
    <tr tal:condition="python: nbOfMeetings <= maxShownMeetings"
        tal:repeat="meetingBrain meetingBrains">
      <td class="portletCell">
        <a tal:attributes="href meetingBrain/getURL;
                           class python: context.absolute_url().startswith(meetingBrain.getURL()) and 'portletSelected' or ''"
           tal:content="python:tool.formatMeetingDate(meetingBrain, short=True, withHour=True)"></a>
      </td>
    </tr>

    <tal:comment replace="nothing">Many meetings. Show a combo box</tal:comment>
    <tr tal:condition="python: nbOfMeetings > maxShownMeetings">
     <td class="portletCell">
      <form name="gotoMeetingForm">
        <select style="width: 90%" name="selectMeeting" onChange="location.href=gotoMeetingForm.selectMeeting.options[selectedIndex].value">
          <option i18n:translate="make_a_choice"
                  tal:attributes="value python:meetingFolder.absolute_url() + '/plonemeeting_topic_view?search=searchallmeetings'"></option>
          <option tal:repeat="meetingBrain meetingBrains"
                  tal:content="python:tool.formatMeetingDate(meetingBrain, short=True, withHour=True)"
                  tal:attributes="value meetingBrain/getURL;
                                  selected python:context.absolute_url().startswith(meetingBrain.getURL())"></option>
        </select>
      </form>
     </td>
    </tr>

    <tr tal:condition="python: nbOfMeetings==0">
      <td class="portletCell"><i class="discreet" i18n:translate="no_meeting"></i></td>
    </tr>
  </tal:links>
  </tal:meetings>

  <tal:decisions>
  <tal:comment replace="nothing">Section: decisions</tal:comment>
  <tr><td class="portletSection" i18n:translate="portletdecisions_title">Decisions</td></tr>

  <tal:comment replace="nothing">List of available decisions</tal:comment>
  <tal:links define="pc python:context.portal_catalog;
                     portalTypeName meetingConfig/getMeetingTypeName;
                     meetingStates meetingConfig/getDecisionTopicStates;
                     meetingBrains python:pc(portal_type=portalTypeName, review_state=meetingStates, sort_on='getDate', sort_order='reverse', getDate={'query': currentDateTime-meetingConfig.getMaxDaysDecisions(), 'range': 'min'},);
                     nbOfMeetings python:len(meetingBrains);
                     maxShownMeetings meetingConfig/maxShownMeetings">

    <tal:comment replace="nothing">A few number of meetings: show a link by meeting</tal:comment>
    <tr tal:condition="python: nbOfMeetings <= maxShownMeetings"
        tal:repeat="meetingBrain meetingBrains">
     <td class="portletCell">
      <a tal:attributes="href meetingBrain/getURL;
                         class python: context.absolute_url().startswith(meetingBrain.getURL()) and 'portletSelected' or ''"
         tal:content="python:tool.formatMeetingDate(meetingBrain, short=True, withHour=True)"></a>
     </td>
    </tr>

    <tal:comment replace="nothing">Many meetings! Show a combo box</tal:comment>
    <tr tal:condition="python: nbOfMeetings > maxShownMeetings">
     <td class="portletCell">
      <form name="gotoDecision">
        <select name="selectDecision" onChange="location.href=gotoDecision.selectDecision.options[selectedIndex].value">
          <option i18n:translate="make_a_choice"
                  tal:attributes="value python:meetingFolder.absolute_url() + '/plonemeeting_topic_view?search=searchalldecisions'"></option>
          <option tal:repeat="meetingBrain meetingBrains"
                  tal:content="python:tool.formatMeetingDate(meetingBrain, short=True, withHour=True)"
                  tal:attributes="value meetingBrain/getURL;
                                  selected python:context.absolute_url().startswith(meetingBrain.getURL())"></option>
        </select>
      </form>
     </td>
    </tr>
  </tal:links>

  <tal:comment replace="nothing">All decisions</tal:comment>
  <tr>
   <td class="portletCell">
    <a tal:attributes="href python: meetingFolder.absolute_url() + '/plonemeeting_topic_view?search=searchalldecisions';
                       class python: 'searchalldecisions' == context.REQUEST.form.get('search', '') and 'portletSelected' or ''"
       i18n:translate="searchalldecisions"></a>
   </td>
  </tr>
  </tal:decisions>
</table>

<script language="javascript" tal:content="tool/getJavascriptMessages"></script>
</dl>
</body>
</html>
