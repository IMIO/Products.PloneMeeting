<tal:comment replace="nothing">
  This Ajax-called macro displays an object's history.
</tal:comment>
<div id="content" define-macro="history" i18n:domain="plone"
      tal:define="historyInfo python: context.getHistory(0, batchSize=1000);
                  objs        historyInfo/events;
                  showColors  python: context.portal_plonemeeting.showColorsForUser();">

  <tal:comment replace="nothing">Table containing the history</tal:comment>
  <tal:history condition="objs">
  <table class="listing nosort" style="width: 100%">
   <thead>
    <tr>
      <th i18n:translate="listingheader_action" width="125px">Action</th>
      <th i18n:translate="listingheader_performed_by" width="175px">Performed by</th>
      <th i18n:translate="listingheader_date_and_time" width="150px">Date and time</th>
      <th i18n:translate="history_details">Details</th>
    </tr>
   </thead>
   <tbody>
    <tal:event repeat="event objs">
    <tr tal:define="odd repeat/event/odd;
                    rhComments event/comments|nothing;
                    state event/review_state|nothing;
                    isDataChange python: event['action'] == '_datachange_'"
        tal:attributes="class python: odd and 'even' or 'odd'" valign="top">
      <td tal:condition="isDataChange">
        <span i18n:translate="data_change"></span>
        <img tal:condition="python: member.has_role('Manager')" style="cursor:pointer"
             tal:attributes="src string:$portal_url/delete.png;
                             onClick python: 'deleteEvent(\'%s\', \'%s\')' % (context.UID(), event['time'])"/>
      </td>
      <td class="#"
          tal:condition="not: isDataChange"
          tal:define="actionTitle python: event['action'] and view.getTransitionTitle(event['action']) or 'Created'"
          tal:content="actionTitle" i18n:translate=""
          tal:attributes="class python: showColors and ('transition-%s' % str(actionTitle).lower()) or ''">Action</td>
      <td tal:define="actorid python:event.get('actor');
                      actor python:context.portal_membership.getMemberInfo(actorid);
                      fullname actor/fullname|nothing;
                      username actor/username|nothing"
          tal:content="python:fullname or username or actorid"/>
      <td tal:content="python:context.restrictedTraverse('@@plone').toLocalizedTime(event['time'],long_format=True)"/>
      <td tal:condition="not: isDataChange"><tal:comment condition="rhComments" i18n:translate="" tal:content="structure rhComments"/>
        <tal:noComment condition="not: rhComments" i18n:translate="no_comments"/></td>
      <td tal:condition="isDataChange">
        <tal:comment replace="nothing">
          Display the previous values of the fields whose value were modified in this change.</tal:comment>
        <table class="dataChanges" width="100%">
          <tr>
            <th align="left" width="30%" i18n:translate="modified_field"></th>
            <th align="left" width="70%" i18n:translate="previous_value"></th>
          </tr>
          <tr tal:repeat="change event/changes/items" valign="top">
            <tal:change define="field python:context.getField(change[0])">
            <td tal:content="python: context.translate(field.widget.label_msgid, domain=field.widget.i18n_domain)"></td>
            <td tal:content="structure python: change[1]"></td>
            </tal:change>
          </tr>
        </table>
      </td>
    </tr>
    </tal:event>
   </tbody>
  </table>
  </tal:history>
</div>