<tal:comment replace="nothing">Displays advices as icons. Requires "meetingItem".</tal:comment>
<metal:icons metal:define-macro="advicesIcons" i18n:domain="PloneMeeting"
     tal:define="advicesByType meetingItem/getAdvicesByType;
                 advisableGroups meetingItem/getAdvicesGroupsInfosForUser;
                 advicesToAdd python: advisableGroups[0];">
  <table width="#"
         class="contentActionsAX no-style-table" cellpadding="0" cellspacing="0"
         tal:attributes="width python: 10 + (advicesToAdd and 1 or 0) * 15 + len(advicesByType) * 26"
         style="margin: 0;">
    <tr>
      <tal:advicesToAddOrExisting condition="python: advicesByType or advicesToAdd">
      <tal:definesIfSomethingToShow define="advicesToEdit python: advisableGroups[1];
                                            adviceStyle python: meetingConfig.getUserParam('adviceStyle', context.REQUEST);
                                            item_url meetingItem/absolute_url;
                                            portal context/@@plone_portal_state/portal;
                                            tool python: portal.portal_plonemeeting;
                                            portal_url context/@@plone_portal_state/portal_url;
                                            plone_view context/@@plone;
                                            displayAdviceConfidentiality python: meetingConfig.getEnableAdviceConfidentiality() and tool.isManager(meetingItem);
                                            isRealManager python: tool.isManager(meetingItem, realManagers=True);
                                            item_review_state meetingItem/queryState;
                                            adviceFileTypes python: meetingConfig.getFileTypes('advice');">
      <tal:comment replace="nothing">Icon for adding an advice</tal:comment>
      <td tal:condition="advicesToAdd" class="noPadding">
        <a href="++add++meetingadvice" class="link-overlay-pm-advice" tal:attributes="href string:${item_url}/++add++meetingadvice">
          <img i18n:attributes="title" title="advice_add" style="cursor:pointer"
               tal:attributes="src string:$portal_url/new.png;" />
        </a>
      </td>
      <tal:comment replace="nothing">For history reasons, we use meetingConfig.listAdviceTypes to be sure
                                     that a deactivated adviceType is still shown.</tal:comment>
      <tal:menu repeat="adviceType python: meetingConfig.listAdviceTypes().keys() + ['not_given', 'hidden_during_redaction', 'considered_not_given_hidden_during_redaction']">
      <td tal:condition="python: adviceType in advicesByType" class="noPadding">
        <dl class="actionMenuAX">
          <dt class="actionMenuHeaderAX pmLinks"><tal:comment replace="nothing">Icon with advice type</tal:comment>
              <a href="#">
                <img tal:attributes="src string:$portal_url/advice_${adviceStyle}_$adviceType.png;
                                     title adviceType;"
                     i18n:attributes="title"/><span tal:replace="python: len(advicesByType[adviceType])"></span>
              </a>
          </dt>
          <dd class="actionMenuContentAX actionMenuContentAdvice">
            <ul style="cursor:default">
              <tal:comment replace="nothing">List of group names</tal:comment>
              <li tal:repeat="advice python:advicesByType[adviceType]">

                <fieldset tal:define="tool python: portal.portal_plonemeeting;
                                      mGroup python: getattr(tool, advice['id']);
                                      memberIsAdviserForGroup python:  advice['id'] in [group.getId() for group in tool.getGroupsForUser(suffix='advisers')];
                                      obj python: advice.get('advice_id', None) and getattr(meetingItem, advice['advice_id']) or None;
                                      mayEdit python: (advicesToEdit and advice['id'] in advicesToEdit) or (isRealManager and not adviceType == 'not_given');
                                      customMessageInfos python: meetingItem.adapted().getCustomAdviceMessageFor(advice);
                                      displayDefaultComplementaryMessage customMessageInfos/displayDefaultComplementaryMessage;
                                      customAdviceMessage customMessageInfos/customAdviceMessage;">
                    <legend>
                         <span tal:condition="advice/delay">
                              <img src="advice_with_delay_big.png"
                                   tal:attributes="src string:${portal_url}/advice_with_delay_big.png;"/>
                              <span class="advice_delay"
                                    tal:content="advice/delay_infos/left_delay"
                                    tal:define="class_if_not_given string:advice_delay advice_delay_${advice/delay_infos/delay_status};"
                                    tal:attributes="class python: (advice['type'] == 'not_given' or advice['hidden_during_redaction']) and class_if_not_given or 'advice_delay'" />
                         </span>
                         <div style="display: inline-block; vertical-align: middle; max-width: 420px;">
                         <span tal:condition="advice/optional">(</span><b tal:content="structure advice/name"></b>
                              <tal:showDelayLabel condition="python: advice['delay'] and advice['delay_label']">
                                   - <b tal:content="advice/delay_label"></b>
                              </tal:showDelayLabel><span tal:condition="advice/optional">)</span>
                         </div>
                         <div style="max-width: 90px; float: right;" >
                         <acronym tal:attributes="title python: meetingItem.getAdviceHelpMessageFor(**advice)">&nbsp;?&nbsp;</acronym>
                         <acronym tal:condition="displayAdviceConfidentiality" style="border-bottom: none;">
                            <metal:isConfidential use-macro="here/@@advices-macros/isConfidential" />
                         </acronym>
                         <acronym tal:condition="advice/delay" title="Change delay" i18n:attributes="title">
                            <tal:advice-change-delay
                              tal:define="dummy python: context.REQUEST.set('advice_change_delay_advice', advice);
                                          dummy python: context.REQUEST.set('advice_change_delay_cfg', meetingConfig);"
                              replace="structure meetingItem/@@advice-available-delays/index" />
                         </acronym>
                         <acronym tal:condition="advice/advice_id|nothing" style="margin-left: 0.2em; padding-right: 0.2em;">
                            <a class="overlay-history"
                               title="History"
                               i18n:domain="plone"
                               i18n:attributes="title"
                               style="display: inline-block;"
                               href="@@historyview"
                               tal:attributes="href string:${obj/absolute_url}/@@historyview">
                                <img src="++resource++imio.actionspanel/history.gif"
                                     tal:attributes="src string:${portal_url}/++resource++imio.actionspanel/history.gif"/>
                            </a>
                         </acronym>
                         </div>
                    </legend>

                <tal:notHiddenUnderRedactionOrManagable condition="python: memberIsAdviserForGroup or mayEdit or not adviceType in ('hidden_during_redaction', 'considered_not_given_hidden_during_redaction')">

                <table class="no-style-table advices" cellpadding="2" cellspacing="2" width="100%">
                  <tr tal:condition="mayEdit">
                    <td class="noPadding" width="auto">
                    </td>
                    <td align="right" width="20px" class="noPadding">
                        <tal:editableOrLocked define="adviceIsLocked python: obj and obj.wl_isLocked() or False;">
                            <a href="edit"
                               tal:condition="not: adviceIsLocked"
                               class="link-overlay-pm-advice"
                               tal:attributes="href string:${item_url}/${advice/advice_id}/edit">
                              <img i18n:attributes="title" title="advice_edit"
                                   tal:attributes="src string:$portal_url/edit.gif;" />
                            </a>
                            <a href="view"
                               tal:condition="adviceIsLocked"
                               tal:attributes="href string:${item_url}/${advice/advice_id}/view">
                              <img i18n:attributes="title" title="Locked"
                                   i18n:domain="plone"
                                   tal:attributes="src string:$portal_url/lock_icon.png;" />
                            </a>
                        </tal:editableOrLocked>
                    </td>
                    <td align="right" width="20px" class="noPadding">
                    <a href="view"
                       tal:attributes="href string:${item_url}/${advice/advice_id}/view">
                      <img i18n:attributes="title" title="Advice advanced management screen"
                           tal:attributes="src string:$portal_url/advice_manage.png;" />
                    </a>
                    </td>
                    <td tal:condition="python: adviceFileTypes or bool(advice['annexIndex'])" align="right" width="20px" class="noPadding">
                      <a href="#"
                         tal:attributes="href string:${item_url}/${advice/advice_id}/annexes_form">
                        <img src="manage_annexes.gif"
                             i18n:attributes="title" title="Manage advice annexes"
                             tal:attributes="src string:${portal_url}/manage_annexes.gif"/>
                      </a>
                    </td>
                    <td align="right" width="20px" class="noPadding">
                      <form action="deleteAdvice" name="deleteAdvice" tal:attributes="action python: meetingItem.absolute_url() + '/@@delete_givenuid'">
                        <input type="hidden" value="#" name="object_uid" tal:attributes="value advice/advice_uid">
                        <img style="cursor:pointer"
                             tal:attributes="src string:$portal_url/delete_icon.png;"
                             i18n:attributes="title"
                             title="Delete advice"
                             onclick="javascript:confirmDeleteObject(this)" />
                      </form>
                    </td>
                  </tr>
                  <tr tal:condition="python: (adviceType != 'not_given')">
                    <td colspan="4"
                        tal:define="croppedComment python: plone_view.cropText(advice['comment'] or '', 400, '...')">
                        <img tal:attributes="src string:$portal_url/advice_${adviceStyle}_${advice/type}.png;
                                             title string:${advice/type};"
                             i18n:attributes="title" title=""/>
                        <span tal:content="string:${advice/type}" i18n:translate="">Advice type</span>
                        <i tal:condition="croppedComment"
                           tal:content="structure python: croppedComment"></i>
                        <p class="discreet"
                              tal:condition="not: croppedComment"
                              i18n:translate="">No complementary comment has been given on this advice.</p>
                    </td>
                  </tr>
                  <tr tal:condition="python: 'advice_id' in advice">
                    <td>
                        <a href="#"
                           class="link-overlay-pm-advice"
                           tal:attributes="href string:${item_url}/${advice/advice_id}/view">
                            <img src="blue_arrow.gif"
                                 tal:attributes="src string:${portal_url}/blue_arrow.gif"/>&nbsp;<span i18n:translate="">Preview detailled advice</span>
                        </a>
                    </td>
                    <td colspan="3"
                        align="right"
                        class="advice_annexes">
                        <tal:defines define="relatedTo string:advice;
                                             extra_css_class string:annexIcon;"
                                     condition="python: bool(obj.annexIndex)">
                            <metal:annexes use-macro="obj/@@annexes-macros/annexesIcons" />
                        </tal:defines>
                    </td>
                  </tr>
                </table>
                <tal:complementaryInfoMessage condition="displayDefaultComplementaryMessage">
                    <tal:adviceGiveableWithoutDelay condition="python: adviceType == 'not_given' and advice['advice_addable'] and not advice['delay_infos']">
                        <span class="discreet"
                              i18n:translate="">The item is viewable by the advisers of this group but the advice has not been given yet.
                        </span>
                    </tal:adviceGiveableWithoutDelay>
                    <tal:adviceGiveableWithDelay condition="python: adviceType == 'not_given' and advice['advice_addable'] and advice['delay_infos']">
                        <span class="discreet"
                              tal:condition="python: advice['delay_infos']['delay_status'] in ['still_time', 'still_time_but_alert']"
                              i18n:translate="">The item is viewable by the advisers of this group but the advice has not been given yet, it can still be given until the <span tal:attributes="class string:advice_delay_${advice/delay_infos/delay_status}"
                                                                                                                          i18n:name="advice_delay_limit_date"
                                                                                                                          tal:content="advice/delay_infos/limit_date_localized"></span>.
                        </span>
                    </tal:adviceGiveableWithDelay>
                    <tal:adviceNoMoreGiveableBecauseDelayExceeded condition="python: adviceType == 'not_given' and not advice['advice_addable'] and advice['delay_infos'] and advice['delay_infos']['delay_status'] == 'timed_out'">
                        <span class="discreet"
                              i18n:translate="">This advice can not be given anymore, it was asked the <span class="advice_delay_timed_out"
                                                                                                             i18n:name="advice_delay_started_on"
                                                                                                             tal:content="advice/delay_infos/delay_started_on_localized">2013/05/05</span>
                                                and could be given until the <span class="advice_delay_timed_out"
                                                                                   i18n:name="advice_delay_limit_date"
                                                                                   tal:content="advice/delay_infos/limit_date_localized">2013/05/15</span>.
                        </span>
                    </tal:adviceNoMoreGiveableBecauseDelayExceeded>
                    <tal:itemsStillNotViewableToAdvisers condition="python: adviceType == 'not_given' and not advice['item_viewable_by_advisers']">
                        <span class="discreet"
                           i18n:translate="">This item is not viewable by the advisers of this group in the current review state (<span i18n:name="item_review_state"
                                                                                                                                       i18n:translate=""
                                                                                                                                       i18n:domain="plone"
                                                                                                                                       tal:content="item_review_state"
                                                                                                                                       tal:attributes="class string:label-state-${item_review_state}"></span>).</span>
                        <br /><span tal:condition="advice/delay_infos"
                                    class="discreet"
                                    i18n:translate="">Once viewable, the adviser will have <span style="font-weight: bold;" i18n:name="advice_delay" tal:content="advice/delay_infos/delay">15</span> days to give the advice.</span>
                    </tal:itemsStillNotViewableToAdvisers>
                    <tal:itemViewableButNoMoreAdviseableWithoutDelay condition="python: adviceType == 'not_given' and advice['item_viewable_by_advisers'] and not advice['delay_infos'] and not advice['advice_addable']">
                        <span class="discreet"
                           i18n:translate="advice_can_no_more_be_given_in_current_item_state">This advice can no more be given in current item state (<span i18n:name="item_review_state"
                                                                                                           i18n:translate=""
                                                                                                           i18n:domain="plone"
                                                                                                           tal:content="item_review_state"
                                                                                                           tal:attributes="class string:label-state-${item_review_state}"></span>)</span>.

                    </tal:itemViewableButNoMoreAdviseableWithoutDelay>
                    <tal:itemViewableButNoMoreAdviseableWithDelay condition="python: adviceType == 'not_given' and advice['item_viewable_by_advisers'] and advice['delay_infos'] and not advice['delay_infos']['delay_status'] == 'timed_out' and not advice['advice_addable']">
                        <span class="discreet"
                           i18n:translate="advice_can_no_more_be_given_in_current_item_state">This advice can no more be given in current item state (<span i18n:name="item_review_state"
                                                                                                           i18n:translate=""
                                                                                                           i18n:domain="plone"
                                                                                                           tal:content="item_review_state"
                                                                                                           tal:attributes="class string:label-state-${item_review_state}"></span>)
                        </span>,
                        <span class="discreet"
                              i18n:translate="possibility_to_advice_stopped_on">the possiblity to give an advice was stopped on
                             <span style="font-weight: bold;"
                                   i18n:name="advice_delay_stopped_on"
                                   tal:content="advice/delay_infos/delay_stopped_on_localized" />
                        </span>,
                        <span tal:attributes="class string:discreet advice_delay_${advice/delay_infos/delay_status_when_stopped};"
                              i18n:translate="delay_left_when_stopped"
                              tal:condition="python: advice['delay_infos']['delay_when_stopped'] > 0"> at this moment, there was
                             <span i18n:name="delay_when_stopped"
                                   tal:content="advice/delay_infos/delay_when_stopped">
                                  10
                             </span> day(s) left to give the advice.
                        </span>
                        <span tal:attributes="class string:discreet advice_delay_${advice/delay_infos/delay_status_when_stopped};"
                              i18n:translate="delay_exceeded_when_stopped"
                              tal:condition="python: advice['delay_infos']['delay_when_stopped'] <= 0 and advice['delay_started_on']"> at this moment, the delay exceeded
                             <span i18n:name="delay_when_stopped"
                                   tal:content="python: -(advice['delay_infos']['delay_when_stopped'])">
                                  10
                             </span><img src="logo.png" /> day(s).
                        </span>
                        <span i18n:translate=""
                              tal:attributes="class string:discreet advice_delay_${advice/delay_infos/delay_status_when_stopped};"
                              tal:condition="python: advice['delay_stopped_on'] and not advice['delay_started_on']">the advice was asked after this date.
                        </span>
                    </tal:itemViewableButNoMoreAdviseableWithDelay>
                </tal:complementaryInfoMessage>
                </tal:notHiddenUnderRedactionOrManagable>


                <tal:complementaryInfoMessage condition="displayDefaultComplementaryMessage">
                <tal:hiddenUnderRedaction condition="python: advice['advice_editable'] and adviceType == 'hidden_during_redaction'">
                    <p>
                        <span class="advice_hidden_during_redaction discreet" i18n:translate="">This advice is currently under redaction by the advisers of the group and is not visible to other groups.</span>
                        &nbsp;<span tal:condition="advice/delay_infos"
                                    class="advice_hidden_during_redaction discreet"
                                    i18n:translate="">This advice must not be 'hidden during redaction' anymore before <span i18n:name="limit_date" tal:content="advice/delay_infos/limit_date_localized">limit date</span> or it will be considered not given.
                        </span>
                    </p>
                </tal:hiddenUnderRedaction>

                <tal:underRedactionNoMoreEditable condition="python: adviceType == 'considered_not_given_hidden_during_redaction'">
                  <p class="discreet" style="color: red;" i18n:translate="">This advice is considered 'Not given' because it was still under redaction when the ability to write the advice was removed to advisers of the group. If you need this advice to be considered, contact relevant meeting managers.</p>
                </tal:underRedactionNoMoreEditable>
                </tal:complementaryInfoMessage>

                <tal:customAdviceMessage condition="customAdviceMessage">
                    <tal:block replace="structure customAdviceMessage" />
                </tal:customAdviceMessage>

                <div tal:condition="python: advice['delay'] and advice['delay_started_on']" class="discreet" style="text-align: right;">
                   <span i18n:translate="">Asked on <span i18n:name="advice_asked_on_date" tal:content="advice/delay_infos/delay_started_on_localized">2013/05/08</span></span>
                   <span tal:condition="python: advice['type'] != 'not_given' and not advice['hidden_during_redaction']"> - <span i18n:translate="">Given on <span i18n:name="advice_given_on_date" tal:content="advice/advice_given_on_localized">2013/05/08</span></span></span>
                </div>
                </fieldset>
              </li>
            </ul>
          </dd>
        </dl>
      </td>
      </tal:menu>
      </tal:definesIfSomethingToShow>
      </tal:advicesToAddOrExisting>
      <td tal:condition="not: advicesByType">-</td>
    </tr>
  </table>
</metal:icons>


<tal:comment replace="nothing">
  This macro manage the isConfidential attribute of advices.
  advice : the relevant adviceInfo from the meetingItem.adviceIndex and meetingItem, the MeetingItem
</tal:comment>
<metal:isConfidential define-macro="isConfidential" i18n:domain="PloneMeeting"
                      tal:define="mayEdit python: meetingItem.adapted().mayEditAdviceConfidentiality();
                                  isConfidential advice/isConfidential;">
  <span tal:condition="mayEdit"
        id="marker_toggle_advice_isconfidential_UID__adviceId#"
        tal:attributes="id string:marker_toggle_advice_isconfidential_${UID}__${advice/id};"
        tal:define="UID meetingItem/UID;
                    baseUrl meetingItem/absolute_url;">
    <img class="adviceIsConfidentialEditable" tal:condition="isConfidential" name="isConfidentialNo" style="cursor:pointer"
         title="advice_is_confidential_yes_edit" i18n:attributes="title"
         tal:attributes="src string:$portal_url/isConfidentialYes.png;
                         onClick python: 'asyncToggleIcon(\''+UID + '__' + advice['id'] +'\', baseUrl=\'' + baseUrl + '\', viewName=\'@@toggle_advice_is_confidential\', baseSelector=\'#marker_toggle_advice_isconfidential_\')'"/>
    <img class="adviceIsConfidentialEditable" tal:condition="not: isConfidential" name="isConfidentialYes" style="cursor:pointer"
         title="advice_is_confidential_no_edit" i18n:attributes="title"
         tal:attributes="src string: $portal_url/isConfidentialNo.png;
                         onClick python: 'asyncToggleIcon(\''+UID + '__' + advice['id'] +'\', baseUrl=\'' + baseUrl + '\', viewName=\'@@toggle_advice_is_confidential\', baseSelector=\'#marker_toggle_advice_isconfidential_\')'"/>
  </span>
  <tal:notMayEdit condition="not: mayEdit">
    <img tal:condition="isConfidential" title="advice_is_confidential_yes" i18n:attributes="title"
         tal:attributes="src string: $portal_url/isConfidentialYes.png"/>
    <img tal:condition="not: isConfidential" title="advice_is_confidential_no" i18n:attributes="title"
         tal:attributes="src string: $portal_url/isConfidentialNo.png"/>
  </tal:notMayEdit>
</metal:isConfidential>
