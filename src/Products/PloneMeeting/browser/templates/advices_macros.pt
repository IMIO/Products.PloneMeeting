<tal:comment replace="nothing">Displays advices as icons. Requires "meetingItem".</tal:comment>
<metal:icons metal:define-macro="advicesIcons" i18n:domain="PloneMeeting"
     tal:define="advicesByType meetingItem/getAdvicesByType;
                 advisableGroups meetingItem/getAdvicesGroupsInfosForUser;
                 advicesToAdd python: advisableGroups[0];">
  <table width="#"
         class="contentActionsAX no-style-table" cellpadding="0" cellspacing="0"
         tal:attributes="width python: 10 + (advicesToAdd and 1 or 0) * 15 + len(advicesByType) * 26">
    <tr>
      <tal:advicesToAddOrExisting condition="python: advicesByType or advicesToAdd">
      <tal:definesIfSomethingToShow define="advicesToEdit python: advisableGroups[1];
                                            adviceStyle python: meetingConfig.getUserParam('adviceStyle', context.REQUEST);
                                            item_url meetingItem/absolute_url;
                                            portal context/@@plone_portal_state/portal;
                                            tool python: portal.portal_plonemeeting;
                                            portal_url context/@@plone_portal_state/portal_url;
                                            plone_view context/@@plone;
                                            isRealManager python: tool.isManager(realManagers=True);
                                            item_review_state meetingItem/queryState;">
      <tal:comment replace="nothing">Icon for adding an advice</tal:comment>
      <td tal:condition="advicesToAdd" class="noPadding">
        <a href="++add++meetingadvice" class="link-overlay-pm-advice" tal:attributes="href string:${item_url}/++add++meetingadvice">
          <img i18n:attributes="title" title="advice_add" style="cursor:pointer"
               tal:attributes="src string:$portal_url/new.png;" />
        </a>
      </td>
      <tal:menu repeat="adviceType python: meetingConfig.getUsedAdviceTypes() + ('not_given',)">
      <td tal:condition="python: adviceType in advicesByType" class="noPadding">
        <dl class="actionMenuAX">
          <dt class="actionMenuHeaderAX pmLinks"><tal:comment replace="nothing">Icon with advice type</tal:comment>
              <a href="#">
                <img tal:attributes="src string:$portal_url/advice_${adviceStyle}_$adviceType.png; title adviceType"
                     i18n:attributes="title"/><span tal:replace="python: len(advicesByType[adviceType])"></span>
              </a>
          </dt>
          <dd class="actionMenuContentAX actionMenuContentAdvice">
            <ul style="cursor:default">
              <tal:comment replace="nothing">List of group names</tal:comment>
              <li tal:repeat="advice python:advicesByType[adviceType]">
                <fieldset tal:define="tool python: portal.portal_plonemeeting;
                                      mGroup python: getattr(tool, advice['id']);
                                      itemIsViewableByGroup python: item_review_state in (mGroup.getItemAdviceStates(meetingConfig) +
                                                                                          mGroup.getItemAdviceEditStates(meetingConfig) +
                                                                                          mGroup.getItemAdviceViewStates(meetingConfig));
                                      adviceMayBeAdded python: item_review_state in mGroup.getItemAdviceStates(meetingConfig);">
                    <legend>
                         <span tal:condition="advice/delay"
                               tal:define="global delayInfos python: meetingItem.getDelayInfosForAdvice(advice['id']);">
                              <img src="advice_with_delay_big.png" tal:attributes="src string:${portal_url}/advice_with_delay_big.png"/>
                              <span class="advice_delay"
                                    tal:content="delayInfos/left_delay"
                                    tal:define="class_if_not_given string:advice_delay advice_delay_${delayInfos/delay_status};"
                                    tal:attributes="class python: advice['type'] == 'not_given' and class_if_not_given or 'advice_delay'" />
                         </span>
                         <span tal:condition="advice/optional">(</span>
                              <b tal:content="structure advice/name"></b>
                              <tal:showDelayLabel condition="python: advice['delay'] and advice['delay_label']">
                                   - <b tal:content="advice/delay_label"></b>
                              </tal:showDelayLabel>
                         <span tal:condition="advice/optional">)</span>
                         <acronym tal:attributes="title python: meetingItem.getAdviceHelpMessageFor(**advice)">&nbsp;?&nbsp;</acronym>
                    </legend>
                <table class="no-style-table advices" cellpadding="2" cellspacing="2" width="100%"
                       tal:define="mayEdit python: (advicesToEdit and advice['id'] in advicesToEdit) or (isRealManager and not adviceType == 'not_given')">
                  <tr tal:condition="mayEdit">
                    <td class="noPadding" width="auto">
                    </td>
                    <td align="right" width="20px" class="noPadding">
                    <a href="edit"
                       class="link-overlay-pm-advice"
                       tal:attributes="href string:${item_url}/${advice/advice_id}/edit">
                      <img i18n:attributes="title" title="advice_edit" style="cursor:pointer"
                           tal:attributes="src string:$portal_url/edit.gif;" />
                    </a>
                    </td>
                    <td align="right" width="20px" class="noPadding">
                      <a href="#"
                         class="link-overlay-pm"
                         tal:attributes="href string:${item_url}/${advice/advice_id}/annexes_form">
                        <img src="manage_annexes.gif"
                             i18n:attributes="title" title="Manage advice annexes"
                             tal:attributes="src string:${portal_url}/manage_annexes.gif"/>
                      </a>
                    </td>
                    <td align="right" width="20px" class="noPadding">
                      <form action="deleteAdvice" name="deleteAdvice" tal:attributes="action python: meetingItem.absolute_url() + '/@@delete_givenuid'">
                        <input type="hidden" value="#" name="selected_uid" tal:attributes="value advice/advice_uid">
                        <img style="cursor:pointer"
                             tal:attributes="src string:$portal_url/delete_icon.png;"
                             i18n:attributes="title"
                             title="Delete advice"
                             onclick="javascript:confirmDeleteObject(this)" />
                      </form>
                    </td>
                  </tr>
                  <tr tal:condition="python: (adviceType != 'not_given')">
                    <td colspan="4"
                        tal:define="croppedComment python: plone_view.cropText(advice['comment'] or '', 400, '...')">
                      <i tal:condition="croppedComment"
                         tal:content="structure python: croppedComment"></i>
                      <span class="discreet"
                            tal:condition="not: croppedComment"
                            i18n:translate="">No complementary comment has been given on this advice.</span>
                    </td>
                  </tr>
                  <tr tal:condition="python: 'advice_id' in advice">
                    <td>
                        <a href="#"
                           class="link-overlay-pm"
                           tal:attributes="href string:${item_url}/${advice/advice_id}/view">
                            <img src="access_detailled_advice.gif"
                                 tal:attributes="src string:${portal_url}/access_detailled_advice.gif"/>&nbsp;<span i18n:translate="">Access detailled advice</span>
                        </a>
                    </td>
                    <td colspan="3"
                        align="right"
                        class="advice_annexes">
                        <tal:defines define="obj python: getattr(meetingItem, advice['advice_id']);
                                             relatedTo string:advice;
                                             extra_css_class string:annexIcon;"
                                     condition="python: bool(obj.annexIndex)">
                            <metal:annexes use-macro="obj/@@annexes-macros/annexesIcons" />
                        </tal:defines>
                    </td>
                  </tr>
                  <tr tal:condition="python: advice['type'] != 'not_given' and advice['delay']">
                    <td colspan="4">
                         <div i18n:translate="" class="discreet" style="text-align: right;">This advice was asked on <span i18n:name="advice_asked_on_date" tal:content="python: context.toLocalizedTime(advice['delay_started_on'])">2013/05/08</span>
                         and was given on <span i18n:name="advice_given_on_date" tal:content="python: context.toLocalizedTime(advice['advice_given_on'])">2013/05/08</span>.
                         </div>
                    </td>
                  </tr>
                </table>
                <span class="discreet"
                   tal:condition="python: adviceType == 'not_given' and adviceMayBeAdded and not delayInfos"
                   i18n:translate="">The item is viewable by the advisers of this group but the advice has not been given yet.
                </span>
                <tal:adviceGiveableWithDelay condition="python: adviceType == 'not_given' and adviceMayBeAdded and delayInfos">
                    <span class="discreet"
                          tal:condition="python: delayInfos['delay_status'] in ['still_time', 'still_time_but_alert']"
                          i18n:translate="">The item is viewable by the advisers of this group but the advice has not been given yet, it can still be given until the <span tal:attributes="class string:advice_delay_${delayInfos/delay_status}"
                                                                                                                      i18n:name="advice_delay_limit_date"
                                                                                                                      tal:content="delayInfos/limit_date"></span>.
                    </span>
                    <span class="discreet"
                          tal:condition="python: delayInfos['delay_status'] == 'timed_out'"
                          i18n:translate="">This advice can not be given anymore, it could be given until the <span class="advice_delay_timed_out"
                                                                                                                    i18n:name="advice_delay_limit_date"
                                                                                                                    tal:content="delayInfos/limit_date">2013/05/05</span>.
                    </span>
                </tal:adviceGiveableWithDelay>
                <tal:itemsStillNotViewableToAdvisers condition="python: adviceType == 'not_given' and not itemIsViewableByGroup">
                    <span class="discreet"
                       i18n:translate="">This advice is not viewable by the advisers of this group in the current item state (<span i18n:name="item_review_state"
                                                                                                                                   i18n:translate=""
                                                                                                                                   i18n:domain="plone"
                                                                                                                                   tal:content="item_review_state"
                                                                                                                                   tal:attributes="class string:label-state-${item_review_state}"></span>).</span>
                    <br /><span tal:condition="delayInfos"
                                class="discreet"
                                i18n:translate="">Once viewable, the adviser will have <span style="font-weight: bold;" i18n:name="advice_delay" tal:content="delayInfos/delay">15</span> days to give the advice.</span>
                </tal:itemsStillNotViewableToAdvisers>
                <tal:itemViewableButNoMoreAdviseableWithoutDelay condition="python: adviceType == 'not_given' and itemIsViewableByGroup and not delayInfos and not adviceMayBeAdded">
                    <span class="discreet"
                       i18n:translate="advice_can_no_more_be_given_in_current_item_state">This advice can no more be given in current item state (<span i18n:name="item_review_state"
                                                                                                       i18n:translate=""
                                                                                                       i18n:domain="plone"
                                                                                                       tal:content="item_review_state"
                                                                                                       tal:attributes="class string:label-state-${item_review_state}"></span>)</span>.

                </tal:itemViewableButNoMoreAdviseableWithoutDelay>
                <tal:itemViewableButNoMoreAdviseableWithDelay condition="python: adviceType == 'not_given' and itemIsViewableByGroup and delayInfos and not adviceMayBeAdded">
                    <span class="discreet"
                       i18n:translate="advice_can_no_more_be_given_in_current_item_state">This advice can no more be given in current item state (<span i18n:name="item_review_state"
                                                                                                       i18n:translate=""
                                                                                                       i18n:domain="plone"
                                                                                                       tal:content="item_review_state"
                                                                                                       tal:attributes="class string:label-state-${item_review_state}"></span>)
                    </span>,
                    <span class="discreet"
                          i18n:translate="possibility_to_advice_stopped_on">the possiblity to give an advice was stopped on
                         <span style="font-weight: bold;"
                               i18n:name="advice_delay_stopped_on"
                               tal:content="delayInfos/delay_stopped_on" />
                    </span>,
                    <span tal:attributes="class string:discreet advice_delay_${delayInfos/delay_status_when_stopped};"
                          i18n:translate="delay_left_when_stopped"
                          tal:condition="python: delayInfos['delay_when_stopped'] > 0"> at this moment, there was
                         <span i18n:name="delay_when_stopped"
                               tal:content="delayInfos/delay_when_stopped">
                              10
                         </span> day(s) left to give the advice.
                    </span>
                    <span tal:attributes="class string:discreet advice_delay_${delayInfos/delay_status_when_stopped};"
                          i18n:translate="delay_exceeded_when_stopped"
                          tal:condition="python: delayInfos['delay_when_stopped'] <= 0 and advice['delay_started_on']"> at this moment, the delay exceeded
                         <span i18n:name="delay_when_stopped"
                               tal:content="python: -(delayInfos['delay_when_stopped'])">
                              10
                         </span> day(s).
                    </span>
                    <span i18n:translate=""
                          tal:attributes="class string:discreet advice_delay_${delayInfos/delay_status_when_stopped};"
                          tal:condition="python: advice['delay_stopped_on'] and not advice['delay_started_on']">the advice was asked after this date.
                    </span>
                </tal:itemViewableButNoMoreAdviseableWithDelay>
                </fieldset>
              </li>
            </ul>
          </dd>
        </dl>
      </td>
      </tal:menu>
      </tal:definesIfSomethingToShow>
      </tal:advicesToAddOrExisting>
      <td tal:condition="not: advicesByType">-</td>
    </tr>
  </table>

</metal:icons>
