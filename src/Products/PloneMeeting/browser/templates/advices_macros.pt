<tal:comment replace="nothing">Displays advices as icons. Requires "meetingItem".</tal:comment>
<metal:icons metal:define-macro="advicesIcons" i18n:domain="PloneMeeting"
     tal:define="advicesByType meetingItem/getAdvicesByType;
                 adviceStyle python: meetingConfig.getUserParam('adviceStyle');
                 advisableGroups python: meetingItem.getAdvicesGroupsInfosForUser();
                 item_url meetingItem/absolute_url;
                 advicesToAdd python: advisableGroups[0];
                 advicesToEdit python: advisableGroups[1];
                 portal_url context/@@plone_portal_state/portal_url;
                 plone_view context/@@plone;
                 isRealManager python: tool.isManager(realManagers=True);">

  <table width="#"
         class="contentActionsAX no-style-table" cellpadding="0" cellspacing="0"
         tal:attributes="width python: 10 + (advicesToAdd and 1 or 0) * 15 + len(advicesByType) * 26"
         tal:condition="advicesByType">
    <tr>
      <tal:comment replace="nothing">Icon for adding an advice</tal:comment>
      <td tal:condition="advicesToAdd" class="noPadding">
        <a href="++add++meetingadvice" class="link-overlay-pm-advice" tal:attributes="href string:${item_url}/++add++meetingadvice">
          <img i18n:attributes="title" title="advice_add" style="cursor:pointer"
               tal:attributes="src string:$portal_url/new.png;" />
        </a>
      </td>
      <tal:menu repeat="adviceType python: meetingConfig.getUsedAdviceTypes() + ('not_given',)">
      <td tal:condition="python: adviceType in advicesByType" class="noPadding">
        <dl class="actionMenuAX">
          <dt class="actionMenuHeaderAX pmLinks"><tal:comment replace="nothing">Icon with advice type</tal:comment>
              <a href="#">
                <img tal:attributes="src string:$portal_url/advice_${adviceStyle}_$adviceType.png; title adviceType"
                     i18n:attributes="title"/><span tal:replace="python: len(advicesByType[adviceType])"></span>
              </a>
          </dt>
          <dd class="actionMenuContentAX actionMenuContentAdvice">
            <ul style="cursor:default"> <tal:comment replace="nothing">List of group names</tal:comment>
              <li tal:repeat="advice python:advicesByType[adviceType]">
                <fieldset><legend><span tal:condition="advice/optional">(</span><b tal:content="structure advice/name"></b><span tal:condition="advice/optional">)</span></legend>
                <table class="no-style-table advices" cellpadding="2" cellspacing="2" width="100%"
                       tal:define="mayEdit python: (advicesToEdit and advice['id'] in advicesToEdit) or (isRealManager and not adviceType == 'not_given')">
                  <tr tal:condition="mayEdit">
                    <td class="noPadding" width="auto">
                    </td>
                    <td align="right" width="20px" class="noPadding">
                    <a href="edit"
                       class="link-overlay-pm-advice"
                       tal:attributes="href string:${item_url}/${advice/advice_id}/edit">
                      <img i18n:attributes="title" title="advice_edit" style="cursor:pointer"
                           tal:attributes="src string:$portal_url/edit.gif;" />
                    </a>
                    </td>
                    <td align="right" width="20px" class="noPadding">
                      <a href="#"
                         class="link-overlay-pm"
                         tal:attributes="href string:${item_url}/${advice/advice_id}/annexes_form">
                        <img src="manage_annexes.gif"
                             i18n:attributes="title" title="Manage advice annexes"
                             tal:attributes="src string:${portal_url}/manage_annexes.gif"/>
                      </a>
                    </td>
                    <td align="right" width="20px" class="noPadding">
                      <form action="deleteAdvice" name="deleteAdvice" tal:attributes="action python: meetingItem.absolute_url() + '/@@delete_givenuid'">
                        <input type="hidden" value="#" name="selected_uid" tal:attributes="value advice/advice_uid">
                        <img style="cursor:pointer"
                             tal:attributes="src string:$portal_url/delete_icon.png;"
                             i18n:attributes="title"
                             title="Delete advice"
                             onclick="javascript:confirmDeleteObject(this)" />
                      </form>
                    </td>
                  </tr>
                  <tr tal:condition="python: (adviceType != 'not_given')">
                    <td colspan="4"
                        tal:define="croppedComment python: plone_view.cropText(advice['comment'] or '', 400, '...')">
                      <i tal:condition="croppedComment"
                         tal:content="structure python: croppedComment"></i>
                      <span class="discreet"
                            tal:condition="not: croppedComment"
                            i18n:translate="">No complementary comment has been given on this advice.</span>
                    </td>
                  </tr>
                  <tr tal:condition="python: 'advice_id' in advice">
                    <td>
                        <a href="#"
                           class="link-overlay-pm"
                           tal:attributes="href string:${item_url}/${advice/advice_id}/view">
                            <img src="access_detailled_advice.gif"
                                 tal:attributes="src string:${portal_url}/access_detailled_advice.gif"/>&nbsp;<span i18n:translate="">Access detailled advice</span>
                        </a>
                    </td>
                    <td colspan="3"
                        align="right"
                        class="advice_annexes">
                        <tal:defines define="obj python: getattr(meetingItem, advice['advice_id']);
                                             relatedTo string:advice;
                                             extra_css_class string:annexIcon;"
                                     condition="python: bool(obj.annexIndex)">
                            <metal:annexes use-macro="obj/@@annexes-macros/annexesIcons" />
                        </tal:defines>
                    </td>
                  </tr>
                </table>
                <span class="discreet"
                   tal:condition="python: adviceType == 'not_given'"
                   i18n:translate="">This advice has not been given yet.</span>
                </fieldset>
              </li>
            </ul>
          </dd>
        </dl>
      </td>
      </tal:menu>
    </tr>
  </table>
  <span tal:condition="not: advicesByType">-</span>
</metal:icons>
