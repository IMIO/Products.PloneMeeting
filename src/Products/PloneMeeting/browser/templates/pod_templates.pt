<div i18n:domain="PloneMeeting" align="right" style="margin-bottom: 0.4em"
     tal:define="tool view/getPloneMeetingTool;
                 meetingConfig view/getCurrentMeetingConfig;
                 portal_url view/getPortalUrl;
                 member tool/portal_membership/getAuthenticatedMember;
                 currentObj view/getCurrentObject;">

  <script language="javascript">
  <!--
    // Function that allows to generate a meeting document containing selected items.
    function generatePodDocument(contextUid, templateId, isItem, mailingList) {
      var theForm = document.forms["podTemplateForm"];
      theForm.objectUid.value = contextUid;
      theForm.templateId.value = templateId;
      if (mailingList) theForm.mailingList.value = mailingList;
      if (isItem) {
        theForm.templateId.value = templateId;
        theForm.submit();
      }
      else {
        var uidList = '';
        var atLeastOneSelected = false;
        for (var uid in itemUids) {

          if ((typeof itemUids[uid] == 'boolean') && itemUids[uid]) {
              atLeastOneSelected = true;
              uidList += uid + ',';
          }
        }
        if (! atLeastOneSelected) {
          alert(no_selected_items);
        }
        else {
          // Update the form and submit it.
          theForm.templateId.value = templateId;
          theForm.itemUids.value = uidList;
          theForm.submit();
        }
      }
    }
  -->
  </script>

  <tal:comment replace="nothing">Form submitted when a meeting/item needs to be generated as a document.</tal:comment>
  <form name="podTemplateForm" method="post"
        tal:attributes="action python: tool.absolute_url() + '/generateDocument';
                        target python: meetingConfig.getUserParam('openAnnexesInSeparateWindows', context.REQUEST) and '_blank' or ''">
    <input type="hidden" name="objectUid"/>
    <input type="hidden" name="templateId"/>
    <input type="hidden" name="itemUids" value=""/>
    <input type="hidden" name="mailingList" value=""/>
  </form>
  <span class="discreet" style="position: relative;"
        tal:attributes="title python: podTemplate.Description(mimetype='text/plain');"
        tal:define="isItemParam python: (currentObj.meta_type == 'MeetingItem') and 'true' or 'false'"
        tal:repeat="podTemplate python: meetingConfig.getAvailablePodTemplates(currentObj)">
    <a tal:attributes="onclick python: 'generatePodDocument(\'%s\',\'%s\',%s)' % (currentObj.UID(), podTemplate.getId(), isItemParam)" style="cursor: pointer">
      <span tal:define="fmt podTemplate/getPodFormat"
            tal:attributes="class string:pod_template_icon_${fmt}"
            tal:content="structure python: podTemplate.getName().replace(' ', '&nbsp;')"/>
    </a>
    <tal:comment replace="nothing">Send the document by email.</tal:comment>
    <tal:mail define="mailingLists python: podTemplate.getAvailableMailingLists(currentObj, member)"
              condition="mailingLists">
    <img src="sendMail.gif"
         tal:attributes="onClick python:'toggleMenu(\'%s\')' % podTemplate.getId();
                         src string:${portal_url}/sendMail.gif;"
         style="cursor:pointer; position: relative;"/>
    <div tal:define="menuId python: 'pm_menu_%s' % podTemplate.getId()"
         tal:attributes="id menuId; name menuId" class="pmDropdown podTemplateSendmail">
      <div tal:repeat="name mailingLists">
        <a style="cursor: pointer" tal:content="name"
           tal:attributes="onclick python: 'generatePodDocument(\'%s\',\'%s\',%s,\'%s\')' % (currentObj.UID(), podTemplate.getId(), isItemParam, name)"></a>
      </div>
            <div style="text-align: right;"
                 tal:attributes="onClick python:'toggleMenu(\'%s\')' % podTemplate.getId();">
                <img style="bottom: -13px; position: absolute; right: -13px; cursor: pointer;"
                     src="pb_close_small.png"
                     tal:attributes="src string:${portal_url}/pb_close_small.png"/>
            </div>
    </div>
    </tal:mail>
  &nbsp;
  </span>
</div>
